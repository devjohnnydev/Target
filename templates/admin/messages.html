{% extends "base.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div
        class="flex flex-col lg:flex-row justify-between items-start lg:items-center bg-slate-900/50 p-8 rounded-[2.5rem] border border-white/5 backdrop-blur-md gap-6">
        <div>
            <h1 class="text-3xl font-futuristic text-white mb-2 uppercase tracking-tight italic">Central de <span
                    class="text-amber-400">Suporte</span></h1>
            <p class="text-slate-500 font-bold text-[10px] uppercase tracking-[0.3em]">Gestão de Comunicações e
                Solicitações</p>
        </div>
        <a href="{{ url_for('admin_dashboard') }}"
            class="bg-white/5 hover:bg-white/10 text-white font-futuristic py-4 px-6 rounded-2xl text-[9px] border border-white/10 transition-all uppercase tracking-widest italic">
            ← Voltar Dashboard
        </a>
    </div>

    <!-- Messages List -->
    <div class="grid grid-cols-1 gap-6">
        {% for msg in messages %}
        <div
            class="bg-slate-900/40 border {% if not msg.is_read %}border-amber-500/30 bg-amber-500/5{% else %}border-white/5{% endif %} rounded-[2rem] p-8 transition-all relative group">
            {% if not msg.is_read %}
            <div class="absolute top-8 right-8 w-2 h-2 bg-amber-500 rounded-full animate-ping"></div>
            {% endif %}

            <div class="flex items-start space-x-6">
                <div class="w-12 h-12 rounded-2xl border border-white/10 overflow-hidden bg-white/5 flex-shrink-0">
                    {% if msg.user.photo_url %}
                    <img src="{{ msg.user.photo_url if msg.user.profile_image_type == 'url' else url_for('static', filename='uploads/profiles/' + msg.user.photo_url) }}"
                        class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center text-slate-500 text-xs font-bold">
                        {{ msg.user.name[:2].upper() }}
                    </div>
                    {% endif %}
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <span class="font-futuristic text-white text-sm uppercase italic">{{ msg.user.name }}</span>
                            <span
                                class="text-[9px] font-bold text-slate-500 uppercase tracking-widest ml-3 bg-white/5 px-2 py-0.5 rounded-full">{{
                                msg.user.role }}</span>
                        </div>
                        <span class="text-[9px] font-bold text-slate-600 font-mono">{{ msg.created_at.strftime('%d/%m/%Y
                            %H:%M') }}</span>
                    </div>
                    <p class="text-slate-300 text-xs leading-relaxed italic mb-6">"{{ msg.content }}"</p>

                    <div class="flex items-center space-x-4">
                        {% if not msg.is_read %}
                        <button onclick="markAsRead('{{ msg.id }}', this)"
                            class="bg-amber-500/10 hover:bg-amber-500 text-amber-500 hover:text-slate-950 px-4 py-2 rounded-xl text-[8px] font-bold uppercase tracking-widest border border-amber-500/20 transition-all">
                            Marcar como Lida
                        </button>
                        {% endif %}
                        <a href="mailto:{{ msg.user.email }}"
                            class="bg-blue-500/10 hover:bg-blue-500 text-blue-500 hover:text-white px-4 py-2 rounded-xl text-[8px] font-bold uppercase tracking-widest border border-blue-500/20 transition-all">
                            Responder por Email
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if not messages %}
        <div class="bg-slate-900/40 border border-dashed border-white/5 rounded-[2.5rem] py-20 text-center">
            <p class="text-slate-600 italic text-xs uppercase tracking-widest">Nenhuma mensagem técnica recebida até o
                momento.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function markAsRead(msgId, btn) {
        fetch(`/admin/messages/read/${msgId}`, { method: 'POST' })
            .then(() => {
                btn.closest('.bg-slate-900/40').classList.remove('border-amber-500/30', 'bg-amber-500/5');
                btn.closest('.bg-slate-900/40').classList.add('border-white/5');
                const ping = btn.closest('.bg-slate-900/40').querySelector('.animate-ping');
                if (ping) ping.remove();
                btn.remove();
            });
    }
</script>
{% endblock %}