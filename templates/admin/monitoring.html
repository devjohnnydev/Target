{% extends "base.html" %}

{% block content %}
<div class="space-y-12 pb-20">
    <!-- BI Header -->
    <div
        class="flex flex-col lg:flex-row justify-between items-start lg:items-center bg-slate-900/60 p-10 rounded-[3rem] border border-white/10 backdrop-blur-xl gap-8 relative overflow-hidden group">
        <div
            class="absolute top-0 right-0 w-96 h-96 bg-emerald-500/5 rounded-full blur-[100px] -mr-40 -mt-40 transition-all group-hover:bg-emerald-500/10">
        </div>
        <div class="relative z-10">
            <div
                class="inline-flex items-center space-x-3 bg-emerald-500/10 border border-emerald-500/20 rounded-full px-5 py-2 mb-6">
                <span class="relative flex h-3 w-3">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                    <span
                        class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></span>
                </span>
                <span class="text-emerald-400 text-xs font-bold uppercase tracking-[0.2em]">Command Center Active</span>
            </div>
            <h1 class="text-5xl font-futuristic text-white uppercase italic tracking-tighter leading-none mb-3">
                Bem vindo, <span class="text-neon">{{ current_user.name }}</span></h1>
            <p class="text-slate-400 font-medium tracking-tight text-sm uppercase tracking-[0.1em]">Análise Profissional
                de Unidades de Estudo em Tempo Real</p>
        </div>

        <div class="flex flex-col sm:flex-row items-center gap-4 w-full lg:w-auto relative z-10">
            <div
                class="bg-white/5 border border-white/10 px-8 py-5 rounded-3xl text-center min-w-[140px] backdrop-blur-md">
                <span class="text-slate-500 font-bold text-[10px] uppercase tracking-[0.2em] block mb-1">Data
                    Global</span>
                <span class="text-xl font-futuristic text-white">{{ current_date }}</span>
            </div>
            <div
                class="bg-emerald-500 text-slate-950 px-10 py-5 rounded-3xl text-sm font-futuristic uppercase tracking-[0.2em] shadow-[0_0_30px_rgba(16,185,129,0.3)] border border-emerald-400/20 hover:scale-105 transition-transform cursor-default">
                <span id="activeCount" class="text-2xl mr-2">{{ monitoring_data|selectattr('active_session', 'ne',
                    none)|list|length }}</span> Operacionais
            </div>
        </div>
    </div>

    <!-- Main Monitoring Board (Top 3 Focus) -->
    <div id="monitoringBoard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
        {% for item in monitoring_data %}
        <div class="student-card bg-slate-900/40 rounded-[3rem] p-10 border border-white/5 hover:border-emerald-500/30 transition-all duration-700 flex flex-col group overflow-hidden relative backdrop-blur-sm"
            id="card-{{ item.student.id }}">

            <!-- Animated Scanline -->
            <div
                class="absolute inset-0 bg-gradient-to-b from-transparent via-emerald-500/[0.03] to-transparent h-20 w-full animate-scanline pointer-events-none opacity-0 group-hover:opacity-100">
            </div>

            <div class="relative z-10 flex-grow">
                <!-- Profile & Status -->
                <div class="flex justify-between items-start mb-10">
                    <div class="flex items-center space-x-5">
                        <div
                            class="w-20 h-20 rounded-3xl border-2 border-white/5 p-1 relative overflow-hidden group-hover:border-emerald-500/20 transition-all duration-500 shadow-2xl">
                            {% if item.student.photo_url %}
                            <img src="{{ item.student.photo_url if item.student.profile_image_type == 'url' else url_for('static', filename='uploads/profiles/' + item.student.photo_url) }}"
                                class="w-full h-full object-cover rounded-2xl">
                            {% else %}
                            <div
                                class="w-full h-full bg-slate-800 flex items-center justify-center text-3xl font-futuristic text-slate-500 rounded-2xl">
                                {{ item.student.name[:2].upper() }}
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <h3
                                class="font-futuristic text-xl text-white uppercase italic tracking-tight group-hover:text-emerald-400 transition-colors">
                                {{ item.student.name }}
                            </h3>
                            <div class="flex items-center space-x-2 mt-1">
                                <span
                                    class="w-2 h-2 rounded-full {% if item.active_session %}bg-emerald-500 animate-pulse{% else %}bg-slate-600{% endif %}"></span>
                                <span
                                    class="text-[10px] font-bold {% if item.active_session %}text-emerald-400{% else %}text-slate-500{% endif %} tracking-[0.2em] uppercase">
                                    {% if item.active_session %}Estudando Agora{% else %}Offline{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Focus Subject -->
                <div class="mb-10">
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.4em] mb-4 flex items-center">
                        <svg class="w-3 h-3 mr-2 text-emerald-500" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Objetivo Atual
                    </div>
                    <div
                        class="bg-white/5 rounded-2xl p-5 border border-white/5 group-hover:border-emerald-500/10 transition-all">
                        <div class="text-sm font-futuristic text-white uppercase italic tracking-widest line-clamp-1">
                            {{ item.last_activity or 'AGUARDANDO INÍCIO' }}
                        </div>
                    </div>
                </div>

                <!-- BI Metrics Grid -->
                <div class="grid grid-cols-2 gap-6 mb-10">
                    <div class="bg-slate-950/40 rounded-3xl p-5 border border-white/5 text-center">
                        <div class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Total Global
                        </div>
                        <div class="text-2xl font-futuristic text-white" id="global-minutes-{{ item.student.id }}">
                            {{ (item.total_time_global / 60)|round(1) }}<span
                                class="text-xs text-slate-600 ml-1">h</span>
                        </div>
                    </div>
                    <div
                        class="bg-slate-950/40 rounded-3xl p-5 border border-white/5 text-center relative overflow-hidden group/daily">
                        <input type="date" value="{{ current_date }}"
                            onchange="updateStudentStats({{ item.student.id }}, this.value)"
                            class="absolute inset-0 opacity-0 cursor-pointer z-10">
                        <div class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest mb-2">Total Dia
                        </div>
                        <div class="text-2xl font-futuristic text-emerald-400" id="daily-minutes-{{ item.student.id }}">
                            {{ (item.total_time_today / 60)|round(1) }}<span
                                class="text-[10px] text-emerald-900 ml-1">h</span>
                        </div>
                        <div class="absolute bottom-1 right-1 opacity-20">
                            <svg class="w-3 h-3 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Live Performance Timer -->
                {% if item.active_session %}
                <div
                    class="bg-emerald-500/5 rounded-[2.5rem] p-8 text-center border border-emerald-500/10 mb-6 relative group/timer">
                    <div class="text-[10px] font-bold text-emerald-500/50 uppercase tracking-[0.5em] mb-4">Sessão Ativa
                    </div>
                    <div class="timer text-5xl font-futuristic text-emerald-400 tracking-[0.2em] drop-shadow-[0_0_15px_rgba(16,185,129,0.3)]"
                        data-start="{{ item.active_session.start_time.isoformat() }}">
                        00:00:00
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Footer Stats -->
            <div
                class="mt-auto pt-8 border-t border-white/5 flex justify-between items-center text-[10px] font-bold text-slate-600 uppercase tracking-widest">
                <span>ID: {{ item.student.id|string|batch(4)|first|join }}</span>
                <span class="text-emerald-500/40" id="date-label-{{ item.student.id }}">{{ current_date }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    @keyframes scanline {
        0% {
            transform: translateY(-100%);
        }

        100% {
            transform: translateY(500%);
        }
    }

    .animate-scanline {
        animation: scanline 8s linear infinite;
    }

    .custom-date-picker::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
    }
</style>

<script>
    // Live Timer Engine
    function updateTimers() {
        const timers = document.querySelectorAll('.timer');
        timers.forEach(timer => {
            const start = new Date(timer.dataset.start);
            const now = new Date();
            // Assuming the server provides ISO format which JS parses as UTC if Z is present, 
            // but we might need to handle timezone differences if the server is not UTC.
            // For now, let's assume standard UTC flow.
            const diff = Math.floor((now - start) / 1000);

            if (diff < 0) return; // Prevention for clock drift

            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = diff % 60;

            timer.innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        });
    }

    // Individual Student BI Analytics Engine
    async function updateStudentStats(studentId, date) {
        const dailyEl = document.getElementById(`daily-minutes-${studentId}`);
        const globalEl = document.getElementById(`global-minutes-${studentId}`);
        const dateLabel = document.getElementById(`date-label-${studentId}`);

        // Visual feedback
        dailyEl.classList.add('animate-pulse', 'text-slate-500');
        dateLabel.innerText = "UPDATING...";

        try {
            const response = await fetch(`/admin/student_stats/${studentId}?date=${date}`);
            const data = await response.json();

            // UI Update
            const dailyHours = (data.daily_minutes / 60).toFixed(1);
            const globalHours = (data.global_minutes / 60).toFixed(1);

            dailyEl.innerHTML = `${dailyHours}<span class="text-[10px] text-emerald-900 ml-1">h</span>`;
            globalEl.innerHTML = `${globalHours}<span class="text-xs text-slate-600 ml-1">h</span>`;
            dateLabel.innerText = data.date;

        } catch (error) {
            console.error('BI Update Failed:', error);
            dateLabel.innerText = "ERROR";
        } finally {
            dailyEl.classList.remove('animate-pulse', 'text-slate-500');
        }
    }

    setInterval(updateTimers, 1000);
    updateTimers();

    // Auto-refresh logic for the whole board every 5 minutes to catch new sessions
    // but without losing individual filters.
    setTimeout(() => {
        // window.location.reload(); 
        // In a real pro BI we'd use WebSockets or more granular AJAX polling.
    }, 300000);
</script>
{% endblock %}